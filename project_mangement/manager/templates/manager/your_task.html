{% extends 'manager/base.html' %}

{% block title %}Manager Dashboard{% endblock %}

{% block content %}
<h1 class="mb-4">Your Assigned Tasks</h1>

<div class="row">
    {% for group in grouped_tasks %}
        <div class="col-md-6 mb-4">
            <div class="card shadow-sm">
                <div class="card-header bg-light fw-bold">
                    {{ group.label }}
                </div>
                <div class="card-body">
                    {% if group.tasks.exists %}
                        <ul class="list-unstyled">
                            {% for task in group.tasks %}
                                <li class="mb-3">
                                    <strong>{{ task.title }}</strong> – 
                                    <small class="text-muted">{{ task.deadline }}</small>
                                    <p class="status">
                                        {% if task.assigned_to %}
                                            Status: {{ task.get_status_display }}
                                        {% else %}
                                            <span class="text-danger">Not Assigned</span>
                                        {% endif %}
                                    </p>
                                    <div class="mt-2">
                                        <button class="btn btn-primary change-status-btn" 
                                                data-task-id="{{ task.id }}"
                                                data-current-status="{{ task.status }}">
                                            Change Status
                                        </button>
                                    </div>
                                </li>
                            {% endfor %}
                        </ul>
                    {% else %}
                        <p><em>No tasks in this category.</em></p>
                    {% endif %}
                </div>
            </div>
        </div>
    {% endfor %}
</div>


<script>
// ✅ CSRF token helper from cookie
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            // Does this cookie string begin with the name we want?
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

document.addEventListener("DOMContentLoaded", function () {
    const buttons = document.querySelectorAll(".change-status-btn");
    buttons.forEach(button => {
        button.addEventListener("click", function () {
            const taskId = this.dataset.taskId;
            const currentStatus = this.dataset.currentStatus;
            const newStatus = prompt("Enter new status (todo, in_progress, completed, due):", currentStatus);

            if (newStatus && ['todo', 'in_progress', 'completed', 'due'].includes(newStatus)) {
                const csrfToken = getCookie('csrftoken');

                fetch("{% url 'change_task_status' %}", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "X-CSRFToken": csrfToken
                    },
                    body: JSON.stringify({ task_id: taskId, new_status: newStatus })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert("Status updated successfully!");
                        window.location.reload();
                    } else {
                        alert("Error: " + (data.error || "Unknown error"));
                    }
                })
                .catch(error => {
                    console.error("Error:", error);
                    alert("Network error or server issue.");
                });
            } else {
                alert("Invalid status entered!");
            }
        });
    });
});
</script>
{% endblock %}
